{
  "hash": "2fb4c883eeabb0fc5bd8bbbd1d783045",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Joining Data Together\"\nformat: html\neditor_options: \n  chunk_output_type: console\n---\n\n\nThis lesson introduces techniques for \"joining\" multiple data tables together using a \"key\" variable that serves to identify the individual \"observational units\" in the data. In the NHANES data, each observational unit is an individual respondent of the survey.\n\nA really helpful resource for learning about joins is the [R for Data Science](https://r4ds.had.co.nz/index.html) book (specifically the chapter about [\"Relational Data\"](https://r4ds.had.co.nz/relational-data.html)).\n\nAt the end of this lesson we will have created a *single* data frame that contains the information from both the `demographics` data and the urine albumin and creatinine `labs` data that we load in below:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\n── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──\n✔ dplyr     1.1.4     ✔ readr     2.1.5\n✔ forcats   1.0.0     ✔ stringr   1.5.1\n✔ ggplot2   3.5.1     ✔ tibble    3.2.1\n✔ lubridate 1.9.3     ✔ tidyr     1.3.1\n✔ purrr     1.0.2     \n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter() masks stats::filter()\n✖ dplyr::lag()    masks stats::lag()\nℹ Use the conflicted package (<http://conflicted.r-lib.org/>) to force all conflicts to become errors\n```\n\n\n:::\n\n```{.r .cell-code}\ndemographics <- read_csv(\"data/demographics.csv\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 10175 Columns: 19\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (5): interview_examination, gender, race, marital_status, pregnant\ndbl (9): respondent_id, age_years, age_months_sc_0_2yr, six_month_period, ag...\nlgl (5): served_active_duty_us, served_active_duty_foreign, born_usa, citize...\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n\n```{.r .cell-code}\nlabs <- read_csv(\"data/urine_albumin_creatinine.csv\")\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nRows: 41455 Columns: 3\n── Column specification ────────────────────────────────────────────────────────\nDelimiter: \",\"\nchr (1): lab\ndbl (2): respondent_id, measurement\n\nℹ Use `spec()` to retrieve the full column specification for this data.\nℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.\n```\n\n\n:::\n:::\n\n\n## Determining what kind of join to do\n\nThere are four kinds of joins that you might want to use for combining two tables into a single table:\n\n- An **inner join**, which will keep only the data for the observational units that appear in both tables\n\n- A **left join**, which will keep all of the data for the observational units in the first (left) table, and will add missing values when there is no available data in the second table.\n\n- A **right join**, which will keep all of the data for the observational units in the second (right) table, and will add missing values when there is no available data in the first table.\n\n- A **full join**, which will keep all of the data for the observational units in both the first (left) table, and will add missing values when there is no available data in the other table.\n\nThe kind of join that you will implement will depend on what you want to use your joined data for.\n\nIf you only want to keep observational units that have *complete* data (i.e., data available in both tables), then you will want to perform an *inner join*, but if you don't want to discard observational that are missing from one of the tables, you will want to perform a *full join*.\n\nIdentifying the overlap between the two tables can help determine which type of join makes sense.\n\nSo let's ask the question of *Are there any observations in the demographics table that do not appear in the labs table?*\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# proportion of people in demographics who are also in labs\nsum(demographics$respondent_id %in% labs$respondent_id) / nrow(demographics)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 0.8148403\n```\n\n\n:::\n:::\n\n\nThe calculation above shows that around 81% of observations in the demographics table have available labs data.\n\nWe can also ask the converse question of *Are there any observations in the labs table that do not appear in the demographics table?*\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# proportion of people in labs who are also in demographics\nsum(labs$respondent_id %in% demographics$respondent_id) / nrow(labs)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 1\n```\n\n\n:::\n:::\n\n\nThe calculation above shows that 100% of observations in the labs table have available demographics data. \n\nThis means that all of the people with labs data appear in the demographics data. Which, if our \"left\" table is demographics, and our \"right\" table is labs, means that an *inner join will be the same as a full join*. It also means that a *full join will be the same as a left join*.\n\n\n### Checking the uniqueness of the key ID variables\n\nIt is also helpful to determine whether the key ID values are unique in each table. There are lots of ways to do this, one of which is using the `identical()` function to ask whether the `unique()` version of the `respondent_id` column is equal to the non-`unique()` version.\n\nBelow, we see that the `respondent_id` column is indeed unique for `demographics`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# are the respondent ID values in demographics unique?\nidentical(unique(demographics$respondent_id), demographics$respondent_id)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] TRUE\n```\n\n\n:::\n:::\n\n\nBut not for `labs`:\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# are the respondent ID values in labs unique?\nidentical(unique(labs$respondent_id), labs$respondent_id)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] FALSE\n```\n\n\n:::\n:::\n\n\n## Joining demographics and labs\n\n\nOur two options for to join demographics (left) and labs (right) are:\n\n- An inner or right join will only keep the 81% of people in demographics who have available labs data\n\n- **A left or full join will keep all people in demographics data, and join missing values for those who don't have labs data available**\n\nSince we don't want to discard any data, we will choose the latter, a left/full join. \n\nThe following two pieces of code, one using `left_join()` and the other using `full_join()` are equivalent for this problem:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(left_join(demographics, labs, by = \"respondent_id\"), width = Inf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 43,339 × 21\n   respondent_id interview_examination   gender age_years age_months_sc_0_2yr\n           <dbl> <chr>                   <chr>      <dbl>               <dbl>\n 1         73557 both interview and exam male          69                  NA\n 2         73557 both interview and exam male          69                  NA\n 3         73557 both interview and exam male          69                  NA\n 4         73557 both interview and exam male          69                  NA\n 5         73557 both interview and exam male          69                  NA\n 6         73558 both interview and exam male          54                  NA\n 7         73558 both interview and exam male          54                  NA\n 8         73558 both interview and exam male          54                  NA\n 9         73558 both interview and exam male          54                  NA\n10         73558 both interview and exam male          54                  NA\n   race  six_month_period age_months_ex_0_19yr served_active_duty_us\n   <chr>            <dbl>                <dbl> <lgl>                \n 1 black                1                   NA TRUE                 \n 2 black                1                   NA TRUE                 \n 3 black                1                   NA TRUE                 \n 4 black                1                   NA TRUE                 \n 5 black                1                   NA TRUE                 \n 6 white                1                   NA FALSE                \n 7 white                1                   NA FALSE                \n 8 white                1                   NA FALSE                \n 9 white                1                   NA FALSE                \n10 white                1                   NA FALSE                \n   served_active_duty_foreign born_usa citizen_usa time_in_us education_youth\n   <lgl>                      <lgl>    <lgl>            <dbl>           <dbl>\n 1 TRUE                       TRUE     TRUE                NA              NA\n 2 TRUE                       TRUE     TRUE                NA              NA\n 3 TRUE                       TRUE     TRUE                NA              NA\n 4 TRUE                       TRUE     TRUE                NA              NA\n 5 TRUE                       TRUE     TRUE                NA              NA\n 6 NA                         TRUE     TRUE                NA              NA\n 7 NA                         TRUE     TRUE                NA              NA\n 8 NA                         TRUE     TRUE                NA              NA\n 9 NA                         TRUE     TRUE                NA              NA\n10 NA                         TRUE     TRUE                NA              NA\n   education marital_status pregnant language_english household_income\n       <dbl> <chr>          <chr>    <lgl>                       <dbl>\n 1         3 separated      <NA>     TRUE                        17500\n 2         3 separated      <NA>     TRUE                        17500\n 3         3 separated      <NA>     TRUE                        17500\n 4         3 separated      <NA>     TRUE                        17500\n 5         3 separated      <NA>     TRUE                        17500\n 6         3 married        <NA>     TRUE                        40000\n 7         3 married        <NA>     TRUE                        40000\n 8         3 married        <NA>     TRUE                        40000\n 9         3 married        <NA>     TRUE                        40000\n10         3 married        <NA>     TRUE                        40000\n   lab                         measurement\n   <chr>                             <dbl>\n 1 ur_albumin_ug_ml                    4.3\n 2 ur_albumin_mg_l                     4.3\n 3 ur_creatinine_mg_dl                39  \n 4 ur_creatinine_umol_l             3448. \n 5 ur_albumin_creatinine_ratio        11.0\n 6 ur_albumin_ug_ml                  153  \n 7 ur_albumin_mg_l                   153  \n 8 ur_creatinine_mg_dl                50  \n 9 ur_creatinine_umol_l             4420  \n10 ur_albumin_creatinine_ratio       306  \n# ℹ 43,329 more rows\n```\n\n\n:::\n\n```{.r .cell-code}\nprint(full_join(demographics, labs, by = \"respondent_id\"), width = Inf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 43,339 × 21\n   respondent_id interview_examination   gender age_years age_months_sc_0_2yr\n           <dbl> <chr>                   <chr>      <dbl>               <dbl>\n 1         73557 both interview and exam male          69                  NA\n 2         73557 both interview and exam male          69                  NA\n 3         73557 both interview and exam male          69                  NA\n 4         73557 both interview and exam male          69                  NA\n 5         73557 both interview and exam male          69                  NA\n 6         73558 both interview and exam male          54                  NA\n 7         73558 both interview and exam male          54                  NA\n 8         73558 both interview and exam male          54                  NA\n 9         73558 both interview and exam male          54                  NA\n10         73558 both interview and exam male          54                  NA\n   race  six_month_period age_months_ex_0_19yr served_active_duty_us\n   <chr>            <dbl>                <dbl> <lgl>                \n 1 black                1                   NA TRUE                 \n 2 black                1                   NA TRUE                 \n 3 black                1                   NA TRUE                 \n 4 black                1                   NA TRUE                 \n 5 black                1                   NA TRUE                 \n 6 white                1                   NA FALSE                \n 7 white                1                   NA FALSE                \n 8 white                1                   NA FALSE                \n 9 white                1                   NA FALSE                \n10 white                1                   NA FALSE                \n   served_active_duty_foreign born_usa citizen_usa time_in_us education_youth\n   <lgl>                      <lgl>    <lgl>            <dbl>           <dbl>\n 1 TRUE                       TRUE     TRUE                NA              NA\n 2 TRUE                       TRUE     TRUE                NA              NA\n 3 TRUE                       TRUE     TRUE                NA              NA\n 4 TRUE                       TRUE     TRUE                NA              NA\n 5 TRUE                       TRUE     TRUE                NA              NA\n 6 NA                         TRUE     TRUE                NA              NA\n 7 NA                         TRUE     TRUE                NA              NA\n 8 NA                         TRUE     TRUE                NA              NA\n 9 NA                         TRUE     TRUE                NA              NA\n10 NA                         TRUE     TRUE                NA              NA\n   education marital_status pregnant language_english household_income\n       <dbl> <chr>          <chr>    <lgl>                       <dbl>\n 1         3 separated      <NA>     TRUE                        17500\n 2         3 separated      <NA>     TRUE                        17500\n 3         3 separated      <NA>     TRUE                        17500\n 4         3 separated      <NA>     TRUE                        17500\n 5         3 separated      <NA>     TRUE                        17500\n 6         3 married        <NA>     TRUE                        40000\n 7         3 married        <NA>     TRUE                        40000\n 8         3 married        <NA>     TRUE                        40000\n 9         3 married        <NA>     TRUE                        40000\n10         3 married        <NA>     TRUE                        40000\n   lab                         measurement\n   <chr>                             <dbl>\n 1 ur_albumin_ug_ml                    4.3\n 2 ur_albumin_mg_l                     4.3\n 3 ur_creatinine_mg_dl                39  \n 4 ur_creatinine_umol_l             3448. \n 5 ur_albumin_creatinine_ratio        11.0\n 6 ur_albumin_ug_ml                  153  \n 7 ur_albumin_mg_l                   153  \n 8 ur_creatinine_mg_dl                50  \n 9 ur_creatinine_umol_l             4420  \n10 ur_albumin_creatinine_ratio       306  \n# ℹ 43,329 more rows\n```\n\n\n:::\n:::\n\n\nHowever, notice that the observations in demographics that have labs observations have all been *duplicated* to match the number of rows in the labs data for each respondent. There are now many more rows in our joined data than we had in our demographics data, which is *not* what we want!\n\nAn important lesson is learned here: **if your key ID variable has repeated values, your joined data will too**.\n\n**A good check after completing a join is to make sure that the number of rows in the resulting joined data matches what you expect**\n\nTherefore, to ensure that we have just one row per observational unit (i.e., per `respondent_id` value), we need to join the wide-format `labs_wide` data instead of the long-format `labs` data. \n\nBelow, we compute the wide-format labs data:\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlabs_wide <- labs |> pivot_wider(names_from = \"lab\", values_from = \"measurement\")\nlabs_wide\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8,291 × 6\n   respondent_id ur_albumin_ug_ml ur_albumin_mg_l ur_creatinine_mg_dl\n           <dbl>            <dbl>           <dbl>               <dbl>\n 1         73557              4.3             4.3                  39\n 2         73558            153             153                    50\n 3         73559             11.9            11.9                 113\n 4         73560             16              16                    76\n 5         73561            255             255                   147\n 6         73562            123             123                    74\n 7         73564             19              19                   242\n 8         73566              1.3             1.3                  18\n 9         73567             35              35                   215\n10         73568             25              25                    31\n# ℹ 8,281 more rows\n# ℹ 2 more variables: ur_creatinine_umol_l <dbl>,\n#   ur_albumin_creatinine_ratio <dbl>\n```\n\n\n:::\n:::\n\n\nThen we can see that joining this wide version of the labs data onto the demographics data with a `left_join()` yields a joined dataset with all of the `demographics` and `labs_wide` columns, and the number of rows matches the original `demographics` data.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprint(left_join(demographics, labs_wide, by = \"respondent_id\"), width = Inf)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 10,175 × 24\n   respondent_id interview_examination   gender age_years age_months_sc_0_2yr\n           <dbl> <chr>                   <chr>      <dbl>               <dbl>\n 1         73557 both interview and exam male          69                  NA\n 2         73558 both interview and exam male          54                  NA\n 3         73559 both interview and exam male          72                  NA\n 4         73560 both interview and exam male           9                  NA\n 5         73561 both interview and exam female        73                  NA\n 6         73562 both interview and exam male          56                  NA\n 7         73563 both interview and exam male           0                   5\n 8         73564 both interview and exam female        61                  NA\n 9         73565 interview only          male          42                  NA\n10         73566 both interview and exam female        56                  NA\n   race             six_month_period age_months_ex_0_19yr served_active_duty_us\n   <chr>                       <dbl>                <dbl> <lgl>                \n 1 black                           1                   NA TRUE                 \n 2 white                           1                   NA FALSE                \n 3 white                           2                   NA TRUE                 \n 4 white                           1                  119 NA                   \n 5 white                           1                   NA FALSE                \n 6 mexican american                1                   NA TRUE                 \n 7 white                           2                    6 NA                   \n 8 white                           2                   NA FALSE                \n 9 other hispanic                 NA                   NA FALSE                \n10 white                           1                   NA FALSE                \n   served_active_duty_foreign born_usa citizen_usa time_in_us education_youth\n   <lgl>                      <lgl>    <lgl>            <dbl>           <dbl>\n 1 TRUE                       TRUE     TRUE                NA              NA\n 2 NA                         TRUE     TRUE                NA              NA\n 3 TRUE                       TRUE     TRUE                NA              NA\n 4 NA                         TRUE     TRUE                NA               3\n 5 NA                         TRUE     TRUE                NA              NA\n 6 FALSE                      TRUE     TRUE                NA              NA\n 7 NA                         TRUE     TRUE                NA              NA\n 8 NA                         TRUE     TRUE                NA              NA\n 9 NA                         TRUE     TRUE                NA              NA\n10 NA                         TRUE     TRUE                NA              NA\n   education marital_status pregnant language_english household_income\n       <dbl> <chr>          <chr>    <lgl>                       <dbl>\n 1         3 separated      <NA>     TRUE                        17500\n 2         3 married        <NA>     TRUE                        40000\n 3         4 married        <NA>     TRUE                        70000\n 4        NA <NA>           <NA>     TRUE                        60000\n 5         5 married        <NA>     TRUE                       100000\n 6         4 divorced       <NA>     TRUE                        60000\n 7        NA <NA>           <NA>     TRUE                       100000\n 8         5 widowed        <NA>     TRUE                        70000\n 9         3 married        <NA>     TRUE                       100000\n10         3 divorced       <NA>     TRUE                        17500\n   ur_albumin_ug_ml ur_albumin_mg_l ur_creatinine_mg_dl ur_creatinine_umol_l\n              <dbl>           <dbl>               <dbl>                <dbl>\n 1              4.3             4.3                  39                3448.\n 2            153             153                    50                4420 \n 3             11.9            11.9                 113                9989.\n 4             16              16                    76                6718.\n 5            255             255                   147               12995.\n 6            123             123                    74                6542.\n 7             NA              NA                    NA                  NA \n 8             19              19                   242               21393.\n 9             NA              NA                    NA                  NA \n10              1.3             1.3                  18                1591.\n   ur_albumin_creatinine_ratio\n                         <dbl>\n 1                       11.0 \n 2                      306   \n 3                       10.5 \n 4                       21.0 \n 5                      173.  \n 6                      166.  \n 7                       NA   \n 8                        7.85\n 9                       NA   \n10                        7.22\n# ℹ 10,165 more rows\n```\n\n\n:::\n:::\n\n\n\n## Exercise\n\nHow many rows would you expect an inner join of `demographics` and `labs_wide` to have? Check your answer by conducting the join using `inner_join()` \n\nThe number of rows should match the *intersection* of the two datasets. Since all people in `labs_wide` are also in `demographics`, the join will have the same number of rows in `labs_wide`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nnrow(labs_wide)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 8291\n```\n\n\n:::\n:::\n\n\nThe join can be conducted using `inner_join()` and notice that the number of rows matches `labs_wide`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ninner_join(demographics, labs_wide, by = \"respondent_id\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n# A tibble: 8,291 × 24\n   respondent_id interview_examination   gender age_years age_months_sc_0_2yr\n           <dbl> <chr>                   <chr>      <dbl>               <dbl>\n 1         73557 both interview and exam male          69                  NA\n 2         73558 both interview and exam male          54                  NA\n 3         73559 both interview and exam male          72                  NA\n 4         73560 both interview and exam male           9                  NA\n 5         73561 both interview and exam female        73                  NA\n 6         73562 both interview and exam male          56                  NA\n 7         73564 both interview and exam female        61                  NA\n 8         73566 both interview and exam female        56                  NA\n 9         73567 both interview and exam male          65                  NA\n10         73568 both interview and exam female        26                  NA\n# ℹ 8,281 more rows\n# ℹ 19 more variables: race <chr>, six_month_period <dbl>,\n#   age_months_ex_0_19yr <dbl>, served_active_duty_us <lgl>,\n#   served_active_duty_foreign <lgl>, born_usa <lgl>, citizen_usa <lgl>,\n#   time_in_us <dbl>, education_youth <dbl>, education <dbl>,\n#   marital_status <chr>, pregnant <chr>, language_english <lgl>,\n#   household_income <dbl>, ur_albumin_ug_ml <dbl>, ur_albumin_mg_l <dbl>, …\n```\n\n\n:::\n:::\n\n\n\n\nNote that if there were observations in `labs_wide` that were not in `demographics`, then the resulting inner join will have fewer rows than both tables.",
    "supporting": [],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}